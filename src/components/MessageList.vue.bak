<template>
  <div>
    <div id="message" v-infinite-scroll="loadMore" infinite-scroll-disabled="busy" infinite-scroll-distance="10">
      <div v-for="message in messages" :key="message.id" class="message">
        <div>id={{message.id}} <a href="#">{{message.by}}</a></div>
        <div class="messageContent" v-html="md2html(message.content)"></div>
        <div><button>回覆</button>&nbsp;<button>編輯</button></div>
      </div>
    </div>
    <div v-if="isEnd===false" class="center">載入新資料中，請等候 ...</div>
    <div v-else class="center">資料全部載入完畢，已到結尾！</div>
  </div>
</template>

<script>
import marked from 'marked'

marked.setOptions({
  renderer: new marked.Renderer(),
  gfm: true,
  tables: true,
  breaks: false,
  pedantic: false,
  sanitize: false,
  smartLists: true,
  smartypants: false
})

/* eslint-disable */
export default {
  name: 'MessageList',
  props: ['shared'],
  data () {
    return {
      messages: [],
      isEnd: false,
      busyLoadMore: false
    }
  },
  methods: {
    md2html: function (md) {
      return marked(md)
    },
    loadMore: function () {
      const step = 10
      if (this.busyLoadMore || this.isEnd) return
      this.busyLoadMore = true
      setTimeout(() => {
        let self = this
        let beginId = (this.messages.length === 0) ? 0 : this.messages[this.messages.length-1].id + 1
        var ref = this.shared.db.ref('/messages/').orderByChild('id').startAt(beginId).limitToFirst(step)
        ref.once('value').then(function (snapshot) {
          if (snapshot.numChildren() < step) {
            self.isEnd = true
          }
          snapshot.forEach(function (childSnapshot) {
            let msg = childSnapshot.val()
            self.messages.push(msg)
          })
          // console.log('isEnd', self.isEnd)
        })
        this.busyLoadMore = false
      }, 500)
    }
  }
}
</script>

<style>

/* ================= message ==============*/
.message .messageContent {
  border-top:1px solid #dddddd;
  border-bottom:1px solid #dddddd;
  display: inline-block;
  width: 100%;
}
</style>
